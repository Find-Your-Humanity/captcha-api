name: CI/CD Pipeline for Captcha API Backend

on:
    push:
        branches:
            - main # main 브랜치에 푸시될 때 워크플로우 실행

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest # 워크플로우를 실행할 환경

        steps:
            - name: Checkout application code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.9" 

            - name: Install dependencies
              run: pip install -r requirements.txt

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ secrets.PROJECT_NAME }}.kr-central-2.kcr.dev # KakaoCloud Container Registry URL
                  username: ${{ secrets.ACCESS_KEY }} # <--- ACCESS_KEY를 사용자 이름으로 사용
                  password: ${{ secrets.ACCESS_SECRET_KEY }} # <--- ACCESS_SECRET_KEY를 비밀번호로 사용

            - name: Build and push Docker image
              id: docker_build
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  # KakaoCloud Container Registry 경로에 PROJECT_NAME secret 활용
                  tags: |
                      ${{ secrets.PROJECT_NAME }}.kr-central-2.kcr.dev/${{ secrets.REPOSITORY_NAME }}/captcha-api-backend:${{ github.sha }}
                      ${{ secrets.PROJECT_NAME }}.kr-central-2.kcr.dev/${{ secrets.REPOSITORY_NAME }}/captcha-api-backend:latest

            - name: Checkout Kubernetes manifests repository
              uses: actions/checkout@v4
              with:
                  repository: Find-Your-Humanity/deploy-manifests # <--- 당신의 매니페스트 리포지토리 이름
                  path: deploy-manifests # 매니페스트 리포지토리를 체크아웃할 로컬 경로
                  token: ${{ secrets.PAT }} # <--- PAT secret 사용

            - name: Update image tag in Kubernetes manifest
              run: |
                  IMAGE_TAG="${{ github.sha }}"
                  IMAGE_FULL_PATH="${{ secrets.PROJECT_NAME }}.kr-central-2.kcr.dev/${{ secrets.REPOSITORY_NAME }}/captcha-api-backend:$IMAGE_TAG"

                  # sed 명령어를 사용하여 deployment-captcha-api.yaml 파일의 이미지 태그를 업데이트
                  # 정규식을 사용하여 이미지 태그만 동적으로 변경
                  sed -i -E "s|(image: ${{ secrets.PROJECT_NAME }}.kr-central-2.kcr.dev/${{ secrets.REPOSITORY_NAME }}/captcha-api-backend:)([^ ]+)|\1$IMAGE_TAG|" deployment-captcha-api.yaml

                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add deployment-captcha-api.yaml
                  git commit -m "Update captcha-api-backend image to ${{ github.sha }}" || echo "No changes to commit"
                  git push
              working-directory: ./deploy-manifests # deploy-manifests 디렉토리에서 명령어 실행
